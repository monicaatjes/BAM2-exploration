---
title: "Brand & Communication dashboard"
output: ingmarkdowntemplates::ing_html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Global summary Q1 2020

This document provides you an overview of the KPI's of the CoE Communications and Brand Experience. 

## Desirability
<div class="row">
  <div class="col-md-8" markdown="1">
```{r overview Desirability, echo=F, eval=T, fig.align='left', fig.width=8, fig.height=4}
desi <- test %>%
  dplyr::select(quarter_measurement, country, b_value, desirability) %>%
  dplyr::filter(quarter_measurement >17 & b_value==1) %>%
  dplyr::mutate(
    desirability = desirability
    ) %>%
  distinct()

desi_CAGR <- test %>%
  dplyr::select(quarter_measurement, country, b_value, desirability) %>%
  dplyr::filter(quarter_measurement >17 & b_value==1) %>%
  dplyr::mutate(
    desirability = desirability
    ) %>%
  distinct() %>% 
  # Spread across quarters
  tidyr::spread(quarter_measurement, desirability) %>% 
  # Calculate CAGR
  dplyr::mutate(
    cagr = (`21`/`19`)^(1/2) - 1
  ) %>% 
  # Gather across quarters
  tidyr::gather(quarter_measurement, desirability, -country, -b_value, -cagr) %>% 
  # Filter to per country per time
  dplyr::select(country, cagr) %>% 
  dplyr::distinct()

c <- c("Australia", "Austria", "Belgium", "Czech", "France", "Germany", "Italy", "Luxembourg", 
       "Netherlands", "Poland", "Romania", "Spain", "Turkey", "The Philippines")

desi_p<- plot_ly(
  type = 'table',
  columnwidth = c(50, 30, 30, 30, 30),
  columnorder = c(0, 1, 2, 3, 4),
  header = list(
    values = c("<b>country<b>","<b>Q3 2019<b>", "<b>Q4 2019<b>", "<b>Q1 2020<b>", "<b>CAGR<b>"),
    align = c("left", "right", "right", "right", "right"),
    line = list(width = 1, color = c("rgb 168, 168, 168")),
    fill = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)")),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = rbind(c,
                   round(desi$desirability[desi$quarter_measurement==19], digits=2),
                   round(desi$desirability[desi$quarter_measurement==20], digits=2), 
                   round(desi$desirability[desi$quarter_measurement==21], digits=2),
                   round(desi_CAGR$cagr, digits=2)),
    align = c("left", "right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
desi_p
```
</div>
  <div class="col-md-4" markdown="1">
  <br>
  
* Add explanation what changed for desirability KPI
  </div>
</div>

## Reputation
<div class="row">
  <div class="col-md-8" markdown="1">
```{r overview Reputation, eval=T, echo=F, fig.align='left', fig.height=4, fig.width=8}
rep <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, `RepTrak® Pulse`) %>%
  dplyr::filter(quarter_measurement > 16 & b_value==1) %>%
  dplyr::mutate(
    pulse = case_when(
      country == 1 ~ pulse,
      country == 2 ~ `RepTrak® Pulse`,
      country == 3 ~ `RepTrak® Pulse`,
      country == 4 ~ pulse,
      country == 5 ~ pulse,
      country == 6 ~ `RepTrak® Pulse`,
      country == 7 ~ pulse,
      country == 8 ~ pulse,
      country == 9 ~ `RepTrak® Pulse`,
      country == 10 ~ pulse,
      country == 11 ~ pulse,
      country == 12 ~ pulse,
      country == 13 ~ pulse,
      country == 14 ~ pulse,
      TRUE ~ NA_real_)
  ) %>%
  dplyr::mutate(pulse = case_when(
    country ==14 & quarter_measurement==19 ~ pulse /1.603,
    TRUE ~ pulse
  )) 
rep_CAGR <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse) %>%
  dplyr::filter(quarter_measurement >17 & b_value==1) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>% 
  # Spread across quarters
  tidyr::spread(quarter_measurement, pulse) %>% 
  # Calculate CAGR
  dplyr::mutate(
    cagr = (`21`/`19`)^(1/2) - 1
  ) %>% 
  # Gather across quarters
  tidyr::gather(quarter_measurement, pulse, -country, -b_value, -cagr) %>% 
  # Filter to per country per time
  dplyr::select(country, cagr) %>% 
  dplyr::distinct()
c <- c("Australia", "Austria", "Belgium", "Czech", "France", "Germany", "Italy", "Luxembourg", 
       "Netherlands", "Poland", "Romania", "Spain", "Turkey", "The Philippines")
r <- plot_ly(
  type = 'table',
  columnwidth = c(50, 30, 30, 30, 30),
  columnorder = c(0, 1, 2, 3, 4),
  header = list(
     values = c("<b>country<b>","<b>Q3 2019<b>", "<b>Q4 2019<b>", "<b>Q1 2020<b>", "<b>CAGR<b>"),
    align = c("left", "right", "right", "right", "right"),
    line = list(width = 1, color = c("rgb 168, 168, 168")),
    fill = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)")),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = rbind(c, round(rep$pulse[rep$quarter_measurement==19], digits=2),
                   round(rep$pulse[rep$quarter_measurement==20], digits=2), 
                   round(rep$pulse[rep$quarter_measurement==21], digits=2),
                   round(rep_CAGR$cagr, digits=2)),
    align = c("left", "right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
r
```
</div>
  <div class="col-md-4" markdown="1">
  <br>
  
  * Please note that the reported pulse scores above have a different source than last year. The source of   these scores is the Brand Affinity Monitor. The pulse score for the countries with an extended Reptrek contract (NL, AUT, GE & BE) will be reported by the Reputation Insitute. 
  * Differences will be monitored over time. The methodology is equal, the main difference is that The Reputation Institute corrects for cultural difference. This factor is unknown, so cannot be applied on the BAM pulse scores. 
  </div>
</div>

## Internal NPS
<div class="row">
  <div class="col-md-8" markdown="1">
```{r overview internal NPS, echo=F, eval=T, fig.align='left', fig.width=8, fig.height=4}
### INTERNAL NPS 

internal1 <- internal %>%
  dplyr::select(labels_countries, `2019 Q3`, `2019 Q4`, `2020 Q1`) %>%
  dplyr::filter(!is.na(`2019 Q4`) & 
                  !labels_countries=="Americas" &
                  !labels_countries=="European Network" & 
                  !labels_countries=="Asia" &
                  !labels_countries=="UK region") %>%
  dplyr::mutate(
    # Calculate CAGR
        cagr = (`2020 Q1`/`2019 Q3`)^(1/2) - 1,
  )
  
internal1 <- internal1 %>%
  dplyr::mutate(
    '2019 Q3'= internal1$'2019 Q3' *100,
    '2019 Q4'= internal1$'2019 Q4' *100,
    '2020 Q1'= internal1$'2020 Q1' *100)

internal_tab<- plot_ly(
  type = 'table',
  columnwidth = c(70, 40, 40, 40, 40),
  columnorder = c(0, 1, 2, 3, 4),
  header = list(
    values = c("<b>country<b>","<b>Q3 2019<b>", "<b>Q4 2019<b>", "<b>Q1 2020<b>", "<b>CAGR<b>"),
    align = c("left", "right", "right", "right", "right"),
    line = list(width = 1, color = c("rgb 168, 168, 168")),
    fill = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)")),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = rbind(internal1$labels_countries,
                   round(internal1$`2019 Q3`, digits=2),
                   round(internal1$`2019 Q4`, digits=2),
                   round(internal1$`2020 Q1`, digits=2),
                   round(internal1$cagr, digits=2)),
    align = c("left", "right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
internal_tab
```
  </div>
  <div class="col-md-4" markdown="1">
  <br>
  
  * Please notice that scores of countries with a small amount of colleagues show some fluctuation.
* HR embedded the NPS question in existing surveys (OHI, WPC, pulse) which all have a different context. This might have some impact on the data. 
* Q1 2020 contains scores from the Brand & Communication monitor. Countries with a small base size >50 are not reported. 
  </div>
</div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/aus.png) Australia

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r fun, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==1) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference,
                                                                    digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)", "rgb(255,098,000)"), 
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white",
                                                                       "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"), fill =list(color="white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tab, echo=FALSE, echo=F, eval=T, fig.align="left", fig.width=1.2, fig.height=3.5}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r Australia unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==1 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 

  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r Australia desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==1) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$ANZ, type='scatter', name='ANZ',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Commonwealth, type='scatter', name='Commonwealth',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$NAB, type='scatter', name='NAB',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Westpac, type='scatter', name='Westpac',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r emp, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r Australia Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==1) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * Commonwealth is the most desired brand in the market, closely followed by ING. 
  * ING is considered to be not expensive. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r Australia pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==1 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='ANZ',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Commonwealth',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='NAB',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Westpac',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r emp2, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r Australia love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==1) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
* Australia has a strong and stabile pulse score and outperforms the market.
* Australia has shown stable love scores since last quarter.
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r Australia cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==1) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r Australia customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==1 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000:2000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r Australia avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==1 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1:2),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>  <div class="row">
</div> 
  
  <div class="col-md-12" markdown="1">
  <br>

* Australia showed a positive trend in their amount of primary customers. 
* Ubank is perceived as easiest of all banks in the market. 
  
  <div class="row">
</div></div>


##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/aut.png)   Austria

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funAUT, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==2) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabAUT, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='left'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
     align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r AUT unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==2 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
</div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r AUT desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==2) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BAWAG , type='scatter', name='BAWAG',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Easybank, type='scatter', name='Easybank',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Erste Bank`, type='scatter', name='Erste Bank ',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Raiffeisen, type='scatter', name='Raiffeisen',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r emp4, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 </div> 


  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r AUT Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==2) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
* TEXT
  
  </div> <div class="row">
</div>

### **Reputation**

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r AUT pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==2 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Raiffeisen',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Erste Bank',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Unicredit',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Volksbankensektor',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r emp3, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>

  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r AUT love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google,
                love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==2) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div> <div class="row">  
</div>


  <div class="col-md-12" markdown="1">
  <br>
  
* To provide an overview of the scores compared to the competitors, pulse from the Brand Affinity Monitor is reported (the Reptrak data contains a limited amount of competitors). 
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r AUT cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==2) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r AUT customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==2 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              #showgrid = FALSE,
              range =c(10.000:2000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r AUT avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==2 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1:2),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/BE.png)   Belgium

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funBEL, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==3) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabBEL, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
     align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r BEL unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==3 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r BEL desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters, b_value) %>%
  dplyr::filter(country==3 & b_value<=7) %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  dplyr::distinct() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Belfius Banque` , type='scatter', name='Belfius Banque',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BNP, type='scatter', name='BNP Paribas',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$KBC, type='scatter', name='KBC',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Argenta, type='scatter', name='Argenta',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r emp5, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 </div> 

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r BEL Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==3) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**
  
```{r BEL pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==3 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Belfius Banque',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='BNP Paribas',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='KBC',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  #add_lines(y =~rep_brand$'5', type='scatter', name='Argenta',
         # line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r em, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>

  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r BEL love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==3) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div> <div class="row">  
</div>


  <div class="col-md-12" markdown="1">
  <br>
  
* To provide an overview of the scores compared to the competitors, pulse from the Brand Affinity Monitor is reported (the Reptrak data contains a limited amount of competitors). 
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r BEL cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==3) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r BEL customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==3 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(50.000,2000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r BEL avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==3 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,5),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/cz.png)   Czech Republic

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funCZ, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==4) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabCZ, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r CZ unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==4 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r CZ desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters, b_value) %>%
  dplyr::filter(country==4 & b_value<=7) %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Cesk  spoitelna` , type='scatter', name='Cesk',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$SOB, type='scatter', name='SOB',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Komern  banka`, type='scatter', name='Komern',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Air Bank`, type='scatter', name='Air Bank',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r CZ Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==4) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * ING operates in a competitive market regarding CX. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**
```{r CZ pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==4 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Ceská spoitelna',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='SOB',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Komerní banka',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='UniCredit Bank',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e1, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r CZ love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==4 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r CZ cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==4) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r CZ customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r CZ avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}


```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  No customer data available
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/fr.png)   France

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funFR, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==5) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabFR, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
     align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r FR unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==5 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability**
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r FR desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==5) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`BNP Paribas` , type='scatter', name='BNP Paribas',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Caisse d Epargne`, type='scatter', name='Caisse d Epargne',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Cr dit Agricole`, type='scatter', name='Credit Agricole',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Cr dit Mutuel`, type='scatter', name='Credit Mutuel',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e8, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r FR Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==5) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r FR pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==5 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='BNP Paribas',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Caisse d Epargne',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Crédit Agricole',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Crédit Mutuel',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e9, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r FR love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==5 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  

  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r FR cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==5) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r FR customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==5 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(50.000,500.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r FR avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==5 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/ge.png)   Germany

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funGE, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==6) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabGE, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
     align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r GE unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==6 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r GE desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==6) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Sparkasse , type='scatter', name='Sparkasse',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`VR Banken`, type='scatter', name='VR banken',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Postbank, type='scatter', name='Postbank',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Commerzbank, type='scatter', name='Commerzbank',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e11, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r GE Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==6) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * ING outperforms the market on both dimesions, the most desirable brand of the market and considered to be least expensive. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r GE pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==6 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Sparkasse',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='VR banken',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Postbank',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Commerzbank',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e10, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r GE love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==6 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
* To provide an overview of the scores compared to the competitors, pulse from the Brand Affinity Monitor is reported (the Reptrak data contains a limited amount of competitors). 
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r GE cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==6) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r GE customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==6 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,2000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r GE avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==6 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  ING outperforms the market regarding CX, expecially when it comes to offering smart solutions. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/it.png)   Italy


### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funIT, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==7) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabIT, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
     align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r IT unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==7 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r IT desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==7) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BancoPosta , type='scatter', name='BancoPosta',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BNL, type='scatter', name='BNL',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Intesa Sanpaolo`, type='scatter', name='Intesa Sanpaolo',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Monte dei P diS`, type='scatter', name='Monte dei Paschi di Siena',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e12, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r IT Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==7) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**


```{r IT pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==7 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='BancoPosta',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='BNL',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Intesa Sanpaolo',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Monte dei Paschi di Siena',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e14, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r IT love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==7 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r IT cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==7) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r IT customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==7 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000, 800.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r IT avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==7 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  ING has to deal with a strong market. Banks show similar results regarding CX. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/lu.png)   Luxembourg

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funLUX, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==8) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabLUX, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r LUX unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==8 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r LUX desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==8) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Banque et Caisse` , type='scatter', name='`Banque et Caisse',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`BGL BNP Paribas`, type='scatter', name='BGL BNP Paribas',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Banque de Luxembourg`, type='scatter', name='Banque de Luxembourg',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Raiffeisen, type='scatter', name='Raiffeisen',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e64, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r LUX Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==8) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  

  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r LUX pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==8 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Banque et Caisse',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='BGL BNP Paribas',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Banque International',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Raiffeisen',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e15, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r LUX love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==8 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r LUX cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==8) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r LUX customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==8 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(10.000,100.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r LUX avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==8 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  The new banks (N26 ann Revolut) clearly outperform regarding CX principles. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/nl.png)   The Netherlands 

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funNL, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==9) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabNL, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r NL unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==9 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r NL desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==9) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Rabobank , type='scatter', name='Rabobank',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`ABN AMRO`, type='scatter', name='ABN AMRO',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`SNS bank`, type='scatter', name='SNS bank',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`ASN Bank`, type='scatter', name='ASN Bank',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e65, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r NL Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==9) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * Rabobank is outperforming regarding desirability, closely followed by ING. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r nlpulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==9 & b_value <5) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Rabobank',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='ABN AMRO',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='SNS bank',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e16, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r NL love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==9 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
* To provide an overview of the scores compared to the competitors, pulse from the Brand Affinity Monitor is reported (the Reptrak data contains a limited amount of competitors). 
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r nl cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==9) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r NL customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==9 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              categoryarray = c("Q3_2018", "Q4_2018", "Q1_2019", "Q2_2019", "Q3_2019", "Q4_2019"),
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,8000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r nl avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==9 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,6),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  The comeptition is strong regarding CX principles. Rabobank and ING are competing for the leading position. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/po.png)   Poland

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funPOl, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==10) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabPOL, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r POL unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==10 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
#awa$value[awa$variable==""]

x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r POL desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters, b_value) %>%
  dplyr::filter(country==10 & b_value <=7 ) %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Bank Zachodni`, type='scatter', name='Bank Zachodni',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$mBank, type='scatter', name='mBank',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Pekao S A`, type='scatter', name='Pekao S A',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`PKO BP`, type='scatter', name='PKO BP',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e66, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r POL Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==10) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r POL pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==10 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Bank Zachodni',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='mBank',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Pekao',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='PKO',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e67, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r POL love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==10 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  

  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r POL cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==10) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r POL customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==10 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,4000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r POL avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==10 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  PKO and mBank outperform the market regarding CX, but scores are close. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/ro.png)   Romania

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funROM, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==11) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabROM, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r ROM unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==11 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r ROM desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters, b_value) %>%
  dplyr::filter(country==11 & b_value <=7) %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BCR, type='scatter', name='BCR',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BRD, type='scatter', name='BRD',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Raiffeisen`, type='scatter', name='Raiffeisen',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Banca Transilvania`, type='scatter', name='Banca Transilvania',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e69, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r ROM Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==11) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
* ING and Banca Transilvania share the top position regarding desirability and price perception. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r ROM pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==11 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='BCR',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='BRD',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Raiffeisen Bank',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Banca Transilvania',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r 70, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r ROM love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==11 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r ROM cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==11) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,75),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r ROM customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==11 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )


xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,800.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r ROM avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==11 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              categoryarray = c("Q3_2018", "Q4_2018", "Q1_2019", "Q2_2019", "Q3_2019", "Q4_2019"),
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  Banca Transilvania outperforms ING regarding CX principles. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/sp.png)   Spain

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funSP, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==12) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r tabSP, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r SPA unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==12 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r SPA desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==12) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BBVA, type='scatter', name='BBVA',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Banco Santander`, type='scatter', name='Banco Santander',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Banco Sabadell`, type='scatter', name='Banco Sabadell',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Bankia, type='scatter', name='Bankia',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e71, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r SPA Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==12) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * ING outperforms the market on both dimensions, most desired and not seen as expensive. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r SPA pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==12 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='BBVA',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Banco Santander',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='Banco Sabadell',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Bankia',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r 75, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r SPA love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==12 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
* 
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r SPA cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==12) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r SPA customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", `Primary bank customers`, "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==12 & quarter_measurement >16) %>%
  dplyr::arrange(country)

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,2000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
             # ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r SPA avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==12 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  ING is considered as easiest bank to work with after N26 and Revolut. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/tu.png)   Turkey

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q1**
```{r funTUR, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==13) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r TURtab, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best comp"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r TUR unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==13 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)
  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r TUR desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==13) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$`ING`, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Akbank, type='scatter', name='Akbank',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Garanti`, type='scatter', name='Garanti',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`ISBankas`, type='scatter', name='IsBankasi',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$`Yap`, type='scatter', name='Yap  Kredi',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e78, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r TUR Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==13) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r TUR pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==13 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='Akbank',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Garanti Bankasi',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='ISBankasi',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Yapı Kredi Bankası',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r 76, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r TUR love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==13 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  

  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r TUR cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==13) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r TUR customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}
customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==13 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

customerthing <- customerthing %>%
  dplyr::mutate(
    Diff_year = 1,  
    Diff_growth = customerthing$'Primary bank customers' - lag(customerthing$'Primary bank customers'), 
    Rate_percent = (Diff_growth / Diff_year)/ customerthing$'Primary bank customers' * 100
  )

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Primary customer *1000",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              showline = TRUE,
              showgrid = FALSE,
              range =c(100.000,1000.000),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 50.000,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              #tickwidth = 1,
             # ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p1 <- plot_ly(customerthing, x = ~customerthing$labels_quarters, y = ~customerthing$'Primary bank customers', 
              type = 'bar', name = 'Primary customers', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         barmode = 'group', title= "",
         legend =list(family = "ING me",
                      size = 12,
                      color = 'rgb(105, 105, 105)'))
p1
```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r TUR avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

customerthing <- test_customer_fig %>%
  dplyr::select(labels_quarters, country, b_value, "Active customers", "Primary bank customers", "Avg number of product categories per active customer", quarter_measurement) %>%
  dplyr::filter(b_value ==1 & country ==13 & quarter_measurement >16) %>%
  dplyr::arrange(country) %>%
  dplyr::distinct()

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = TRUE,
              range =c(1,3),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = TRUE,
              #dtick = 0.01,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
              
p2 <- plot_ly(customerthing, x = ~labels_quarters, y = ~customerthing$"Avg number of product categories per active customer", 
              type = 'bar', name = 'average amount of products', marker = list(color = 'rgb(82,81,153)')) %>%
 #add_lines(y = ~Rate_percent, name = 'growth', marker = list(color = "rgb 168, 168, 168")) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))

p2
```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  IsBankasi is clearly outperforming the market regarding CX. 
  
  <div class="row">
</div></div>

##  ![](/Users/xo21bm/Documents/Lokaal/BAM2/exploration/notebooks/ph.png)   The Philippines

### **Brand funnel**
<div class="row">
  <div class="col-md-4" markdown="1">
  
  **Q4**
```{r funPH, echo=FALSE, echo=F, eval=T, fig.width=4, fig.height=3.5}
funnel_data <- test %>%
  dplyr::select(unaided, toma, aided, fami, opinion, consideration, preference, quarter_measurement, b_value, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==14) %>%
  dplyr::mutate(
    unaided_best = max(unaided, na.rm=T) *100, 
    aided_best = max(aided, na.rm=T) * 100, 
    toma_best = max(toma, na.rm=T) * 100, 
    fami_best = max(fami, na.rm=T) * 100, 
    #opinion_best = max(opinion, na.rm=T) * 100, 
    consideration_best = max(consideration, na.rm=T) * 100, 
    preference_best = max(preference, na.rm=T) * 100, 
    unaided = unaided * 100,
    aided = aided * 100,
    toma = toma * 100,
    fami = fami * 100,
    consideration = consideration *100,
    preference = preference *100,
  ) %>%
  dplyr::distinct() 

funnel_data_diff <- funnel_data %>%
  dplyr::select(unaided_best, aided_best, toma_best, fami_best,
                consideration_best, preference_best, unaided, aided, toma, fami, 
                consideration, preference, b_value, quarter_measurement, country) %>%
  dplyr::mutate(
    diff_aided = dplyr::case_when(
      b_value==1 ~ (aided_best - aided),
      TRUE ~ 0),
    diff_fami = dplyr::case_when(
      b_value==1 ~ (fami_best - fami),
      TRUE ~ 0),
    diff_cons = dplyr::case_when(
      b_value==1 ~ (consideration_best - consideration),
      TRUE ~ 0),
    diff_pref = dplyr::case_when(
      b_value==1 ~ (preference_best - preference),
      TRUE ~ 0),
    ) %>%
  dplyr::filter(diff_aided!=0, diff_fami!=0, diff_cons!=0, diff_pref!=0)

funnel_data <- funnel_data %>%
  dplyr::filter(b_value==1)
funnel_plot <- funnel_data %>%
  plot_ly() %>%
  add_trace(type = "funnel",
            y = c("Aided", "Familiarity", "Consideration", "Preference"),
            x = c(round(funnel_data$aided, digits=2), round(funnel_data$fami, digits=2), 
                  round(funnel_data$consideration, digits=2), round(funnel_data$preference, digits=2)),
            textposition = "inside",
            textinfo = "value",
            opacity = 1.0,
            marker = list(color = c("rgb(255,098,000)", "rgb(255,098,000)", "rgb(255,098,000)",
                                    "rgb(255,098,000)"),
                          line = list(width = c(2, 2, 2, 2), color = c("white", "white", "white", "white"))),
            textfont = list(family = "ING me", size = 14, color = "white"),
            connector = list(line = list(color = "white"))) %>%
  layout(yaxis = list(categoryarray = c("Aided", "Familiarity", "Consideration", "Preference"),
                      tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
         xaxis = list(tickfont =list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')),
        legend =list(textfont = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
##
funnel_plot
```
</div>
  <div class="col-md-2" markdown="1">
  
   **Delta best - ING**
   
```{r PHtab, echo=FALSE, echo=F, eval=T, fig.width=1.2, fig.height=3, fig.align='center'}
tab <- plot_ly(
  type = 'table',
  columnwidth = c(1),
  columnorder = c(0),
  header = list(
    values = c("delta best"),
    align = c("left"),
    line = list(width = 1, color = 'black'),
    fill = list(color = "rgb(255,098,000)"),
    font = list(family = "ING me", size = 14, color = "white")
  ),
  cells = list(
    values = cbind(round(funnel_data_diff$diff_aided, digits=2),
                   round(funnel_data_diff$diff_fami, digits=2),
                   round(funnel_data_diff$diff_cons, digits=2),
                   round(funnel_data_diff$diff_pref, digits=2)),
    align = c("right", "right", "right", "right"),
    line = list(color = c("rgb 168, 168, 168"), width = 1),
    font = list(family = "ING me", size = 12, color = c("rgb 105, 105, 105"))
  ))
tab
```
 </div>
  <div class="col-md-2" markdown="1">
  
   **Unaided awareness**
   
```{r PH unaided, echo=F, eval=T, message=F, error=F, warning=F, fig.width=5, fig.height=3.5}
awa <- test %>%
  dplyr::select(b_value, country, labels_countries, labels_quarters,
                quarter_measurement, unaided, toma, aided, main_competition, label) %>%
  dplyr::filter(quarter_measurement > 18 & country==14 & main_competition==1) %>%
  dplyr::group_by(quarter_measurement) %>%
  dplyr::mutate(
    market_average_unaided = mean(unaided *100, na.rm =T), 
    market_average_aided = mean(aided *100, na.rm =T), 
    market_average_toma = mean(toma *100, na.rm =T), 
    best_unaided = max(unaided *100, na.rm =T), 
    best_aided = max(aided *100, na.rm =T), 
    best_toma = max(toma *100, na.rm =T), 
    unaided_ING = case_when(
      b_value ==1 ~ unaided *100,
      TRUE ~ NA_real_),
    aided_ING = case_when(
      b_value ==1 ~ aided *100,
      TRUE ~ NA_real_),
    toma_ING = case_when(
      b_value ==1 ~ toma *100,
      TRUE ~ NA_real_),
    ) %>%
    # Gather across quarters
   # tidyr::spread(quarter_measurement, market_average_unaided) %>%
  dplyr::ungroup() %>%
  distinct() %>%
  dplyr::select(b_value, quarter_measurement, labels_quarters, market_average_unaided, 
                best_unaided, unaided_ING) %>%
  gather(variable, value, -(b_value:labels_quarters)) %>%
  dplyr::filter(b_value==1)
  #unite(temp, quarter_measurement, variable) %>%
  #spread(temp, value)

  
#awa$value[awa$variable==""]
x <-unique(awa$labels_quarters)
y1 <- awa$value[awa$variable=='market_average_unaided']
y2 <- awa$value[awa$variable=='best_unaided']
y3 <- awa$value[awa$variable=='unaided_ING']
datatest <- data.frame(x, y1, y2, y3)
xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
#datatest$x <- factor(datatest$x, levels = data[["x"]])

p1 <- plot_ly(test, x = ~x, y = ~y1, type = 'bar', name = 'market average', marker = list(color = 'rgb(82,81,153)')) %>%
  add_trace(y = ~y2, name = 'best', marker = list(color = "rgb 168, 168, 168")) %>%
  add_trace(y = ~y3, name = 'ING', marker = list(color = 'rgb(255,098,000)')) %>%
  layout(xaxis = xaxis,
         yaxis = yaxis,
         #margin = list(b = 100),
         barmode = 'group', title= "",
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
p1
```
 </div> <div class="row">  
</div>

### **Desirability** 
 </div>
  <div class="col-md-4" markdown="1">
  
   **Evolution over time**
   
```{r PH desi over time, echo=F, eval=T, fig.width=5.6, fig.height=3.5}
## over time desirability per brand
desi_time <- test %>%
  dplyr::select(label, country, quarter_measurement, desirability, labels_quarters) %>%
  dplyr::filter(country==14) %>%
  # There are some NA rows, get rid of them
  tidyr::drop_na() %>%
  # Gather across brands
  tidyr::spread(label, desirability) 

xaxis <- list(title = "",
              textfont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              #range =c(20:90),
              #dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
             # autotick = TRUE,
             # dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
             # tickwidth = 1,
             # ticklen = 10,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_timep1 <-desi_time %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~desi_time$ING, type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BDO, type='scatter', name='BDO',
            line = list(color = 'rgb(96,166,218)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Metrobank, type='scatter', name='Metrobank',
            line = list(color = 'rgb(171,0,102)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$BPI, type='scatter', name='BPI',
            line = list(color = 'rgb(208,217,60)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~desi_time$Unionbank, type='scatter', name='Unionbank',
            line = list(color = 'rgb(52,150,81)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis,
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
desi_timep1
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r e79, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```

</div>

  <div class="col-md-4" markdown="1">
  
  **Price perception vs Desirability**
  
```{r PH Desirability vs price perception, eval=T, echo=F, fig.width=4, fig.height=3.5, warning=FALSE}
desi_comb <- test %>%
  dplyr::select(quarter_measurement, country, label, desirability, price_mean) %>%
  dplyr::filter(quarter_measurement ==21 & country==14) %>%
  dplyr::mutate(
    desirability = desirability,
    price_mean = price_mean
  ) %>%
  distinct()

xaxis <- list(title = "Price perception", 
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(20,80),
              dtick = 10,
              showline = TRUE,
              showgrid = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
yaxis <- list(title = "Desirability",
              titlefont = list(color = 'rgb(105, 105, 105)', size = 12, family = "ING me"),
              range =c(0,75),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

desi_combi <- desi_comb %>%
  plot_ly(x = ~price_mean, y = ~desirability, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '',
         xaxis = xaxis,
         yaxis = yaxis)
desi_combi  
``` 
  </div> <div class="row">  
</div>

  <div class="col-md-12" markdown="1">
  <br>
  
  * BDO is the most desired brand in the marktet, where ING is not (yet) standing out on either desirability or price perception. 
  
  </div> <div class="row">
</div>

### **Reputation** 

  <div class="col-md-4" markdown="1">
  
  **Evoluation over time**

```{r PH pulse, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
rep_brand <- test %>%
  dplyr::select(quarter_measurement, country, b_value, pulse, labels_quarters) %>%
  dplyr::filter(quarter_measurement > 17 & country==14 & b_value <6) %>%
  dplyr::mutate(
    pulse = pulse
  ) %>%
  distinct() %>%
  dplyr::mutate(pulse = case_when(
    quarter_measurement==19 ~ pulse /1.603,
    TRUE ~ pulse
  )) %>%
  # Gather across brands
  tidyr::spread(b_value, pulse) 

xaxis <- list(title = "",
              showline = TRUE,
              showgrid = FALSE,
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              ticklen = 5,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,100),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 10,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

rep_b<-rep_brand %>%
  plot_ly(x = ~labels_quarters) %>%
  add_lines(y = ~rep_brand$'1', type='scatter', name='ING',
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'2', type='scatter', name='BDO',
            line = list(color = 'rgb(96,166,218)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'3', type='scatter', name='Metrobank',
            line = list(color = 'rgb(171,0,102)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'4', type='scatter', name='BPI',
            line = list(color = 'rgb(208,217,60)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~rep_brand$'5', type='scatter', name='Unionbank',
          line = list(color = 'rgb(52,150,81)', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
rep_b
```
</div>
  <div class="col-md-2" markdown="1">
  
   ** **
   
```{r 80, echo=FALSE, echo=F, eval=T, fig.width=1.5, fig.height=3, fig.align='center'}

```
 
</div>
  <div class="col-md-4" markdown="1">  
  
  **Love**
  
```{r PH love, echo=F, eval=T, fig.width=5.5, fig.height=3.5}
love <- test %>%
  dplyr::select(quarter_measurement, country, love_mean_ING, love_mean_Google, love_mean_ING_client, labels_quarters) %>%
  dplyr::filter(quarter_measurement >17 & country==14 & !is.na(love_mean_ING)) %>%
  distinct()

xaxis <- list(title = "",
             # showline = TRUE,
              #showgrid = TRUE,
              #showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              #autotick = TRUE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 2,
              #ticklen = 3,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

yaxis <- list(title = "",
              range =c(0,10),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 1,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              #ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
margin <- list(autoexpand = F)

love$x <-c("2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1")

l<-love %>%
  plot_ly(x = ~x) %>%
  add_lines(y = ~love_mean_ING_client, type='scatter', name='love ING clients', 
            line = list(color = 'rgb(255,098,000)', type='scatter', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_Google, type='scatter', name='love Google',
            line = list(color = 'rgb(82,81,153)', width = 4, mode = 'lines+markers')) %>%
  add_lines(y =~love_mean_ING, type='scatter', name='love ING',
            line = list(color = 'rgb(52, 150, 81', width = 4, mode = 'lines+markers')) %>%
  layout(title = "",
         xaxis = xaxis,
         yaxis = yaxis, legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
l
```
  </div>  <div class="row">
</div> 
  

  <div class="col-md-12" markdown="1">
  <br>
  
* The market has shown a decline in its reputation, where ING has shown steady results.
  
 </div> <div class="row">
</div>

### **Customer**

  <div class="col-md-4" markdown="1">
  
  **CX**
  
```{r PH cx, eval=T, echo=F, fig.width=3.5, fig.height=3.5, warning=FALSE}
easy <- test %>%
  dplyr::select(easy_mean, meets_needs_mean, smart_mean, labels_countries, label, labels_quarters, quarter_measurement, country) %>%
  dplyr::filter(quarter_measurement ==21 & country==14) %>%
  dplyr::filter(!is.na(easy_mean))

yaxis <- list(title = "CX",
              titlefont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'),
              range =c(40,70),
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              dtick = 5,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))

xaxis <- list(title = "",
              showticklabels = TRUE,
              linecolor = 'rgb(204, 204, 204)',
              linewidth = 2,
              autotick = FALSE,
              ticks = 'inside',
              tickcolor = 'rgb(204, 204, 204)',
              tickwidth = 1,
              ticklen = 1,
              tickfont = list(family = "ING me",
                              size = 12,
                              color = 'rgb(105, 105, 105)'))
es <- easy %>%
  plot_ly(x = ~"easy", y = ~easy_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"smart", y = ~smart_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  add_trace(x = ~"meets needs", y = ~meets_needs_mean, type = 'scatter', color ='rgb(255,098,000)',
           mode = 'text+markers', text = ~label, textposition = 'middle right',
           textfont = list(family = "ING me", color = 'rgb(105, 105, 105)', size = 11)) %>%
  layout(title = '', yaxis= yaxis, 
         xaxis = xaxis,
         showlegend = FALSE, 
         legend =list(font = list(family = "ING me", size = 12, color = 'rgb(105, 105, 105)')))
es
```
</div>
  <div class="col-md-4" markdown="1">
  
  **Primairy customer**
  
```{r PH customer, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}

```
</div> 
  
  <div class="col-md-4" markdown="1">
  
  **Average # products**

```{r PH avg products, eval=T, echo=F, error=F, fig.height=3.5, fig.width=4, message=FALSE}


```
  </div>
</div>
  <div class="row">


  <div class="col-md-12" markdown="1">
  <br>
  
*  No data available
  
  <div class="row">
</div></div>